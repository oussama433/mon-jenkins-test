pipeline {
    agent any
    
    stages {
        stage('Test K8s Permissions') {
            steps {
                echo "ðŸ”§ Test des permissions Kubernetes..."
                
                script {
                    // MÃ©thode 1: Utiliser le chemin direct
                    sh '''
                        echo "=== MÃ©thode 1: /snap/bin/microk8s.kubectl ==="
                        /snap/bin/microk8s.kubectl get nodes || echo "âŒ Ã‰chec mÃ©thode 1"
                        echo ""
                        
                        echo "=== MÃ©thode 2: kubectl standard ==="
                        kubectl get nodes || echo "âŒ Ã‰chec mÃ©thode 2"
                        echo ""
                        
                        echo "=== Test crÃ©ation namespace ==="
                        /snap/bin/microk8s.kubectl create namespace jenkins-test-${BUILD_NUMBER} || echo "Namespace existe dÃ©jÃ "
                        /snap/bin/microk8s.kubectl get namespaces | grep jenkins-test
                        echo ""
                        
                        echo "=== Test dÃ©ploiement simple ==="
                        cat > test-pod.yaml <<YAML
apiVersion: v1
kind: Pod
metadata:
  name: test-pod-${BUILD_NUMBER}
  namespace: jenkins-test-${BUILD_NUMBER}
spec:
  containers:
  - name: nginx
    image: nginx:alpine
    ports:
    - containerPort: 80
YAML
                        
                        /snap/bin/microk8s.kubectl apply -f test-pod.yaml || echo "âŒ Ã‰chec dÃ©ploiement"
                        sleep 5
                        /snap/bin/microk8s.kubectl get pods -n jenkins-test-${BUILD_NUMBER}
                        
                        # Nettoyage
                        /snap/bin/microk8s.kubectl delete namespace jenkins-test-${BUILD_NUMBER} || true
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo "ðŸ“Š RÃ©sumÃ© du test de permissions"
            echo "Si tout est vert, ton pipeline Kubernetes fonctionnera !"
        }
    }
}
